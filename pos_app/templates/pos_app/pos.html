<!-- pos_app/templates/pos_app/pos.html -->
{% extends 'pos_app/base.html' %}
{% block title %}Point of Sale{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Product Grid -->
    <div class="product-grid">
        <div class="grid-header">
            <h2><i class="fas fa-boxes"></i> Products</h2>
            <div class="search-box">
                <input type="text" id="productSearch" placeholder="Search products...">
                <i class="fas fa-search"></i>
            </div>
        </div>
        
        <div class="product-list" id="productList">
            {% for product in products %}
            <div class="product-card" data-id="{{ product.id }}">
                <div class="product-info">
                    <h4>{{ product.name }}</h4>
                    <p class="category">{{ product.category.name }}</p>
                    <p class="price">ksh{{ product.price }}</p>
                    <p class="stock">Stock: {{ product.stock }}</p>
                </div>
                <button class="btn-add" onclick="addToCart({{ product.id }})">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Cart Sidebar -->
    <div class="cart-sidebar">
        <div class="cart-header">
            <h2><i class="fas fa-shopping-cart"></i> Current Sale</h2>
            <button class="btn-clear" onclick="clearCart()">
                <i class="fas fa-trash"></i> Clear
            </button>
        </div>
        
        <div class="cart-items" id="cartItems">
            <!-- Cart items will be loaded here -->
            <p class="empty-cart">Cart is empty. Add products to get started.</p>
        </div>
        
        <div class="cart-summary">
            <div class="summary-row">
                <span>Subtotal:</span>
                <span id="subtotal">ksh 0.00</span>
            </div>
            <div class="summary-row">
                <span>Tax (10%):</span>
                <span id="tax">ksh 0.00</span>
            </div>
            <div class="summary-row total">
                <span>Total:</span>
                <span id="total">ksh 0.00</span>
            </div>
            
            <div class="payment-methods">
                <h4>Payment Method</h4>
                <div class="method-options">
                    <label class="method-option">
                        <input type="radio" name="payment" value="cash" checked>
                        <i class="fas fa-money-bill"></i> Cash
                    </label>
                    <label class="method-option">
                        <input type="radio" name="payment" value="card">
                        <i class="fas fa-credit-card"></i> Card
                    </label>
                    <label class="method-option">
                        <input type="radio" name="payment" value="mobile">
                        <i class="fas fa-mobile-alt"></i> Mobile
                    </label>
                </div>
            </div>
            
            <button class="btn-checkout" onclick="checkout()">
                <i class="fas fa-check-circle"></i> Complete Sale
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load cart items on page load
    document.addEventListener('DOMContentLoaded', loadCartItems);
    
    function addToCart(productId) {
        fetch('/api/add-to-cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCartItems();
            }
        });
    }
    
    function loadCartItems() {
        fetch('/api/cart-items/')
            .then(response => response.json())
            .then(data => {
                const cartItems = document.getElementById('cartItems');
                if (data.items.length === 0) {
                    cartItems.innerHTML = '<p class="empty-cart">Cart is empty. Add products to get started.</p>';
                    document.getElementById('subtotal').textContent = 'ksh 0.00';
                    document.getElementById('tax').textContent = 'ksh 0.00';
                    document.getElementById('total').textContent = 'ksh 0.00';
                    return;
                }
                
                let html = '';
                let subtotal = 0;
                
                data.items.forEach(item => {
                    html += `
                        <div class="cart-item" data-id="${item.id}">
                            <div class="item-info">
                                <h4>${item.product}</h4>
                                <p>ksh${item.price} x ${item.quantity}</p>
                            </div>
                            <div class="item-actions">
                                <span class="item-total">ksh ${item.total.toFixed(2)}</span>
                                <button class="btn-remove" onclick="removeItem(${item.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    subtotal += item.total;
                });
                
                cartItems.innerHTML = html;
                
                const tax = subtotal * 0.1;
                const total = subtotal + tax;
                
                document.getElementById('subtotal').textContent = `ksh ${subtotal.toFixed(2)}`;
                document.getElementById('tax').textContent = `ksh ${tax.toFixed(2)}`;
                document.getElementById('total').textContent = `ksh ${total.toFixed(2)}`;
            });
    }
    
    function removeItem(itemId) {
        fetch(`/api/remove-from-cart/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCartItems();
            }
        });
    }
    
    function clearCart() {
        if (confirm('Are you sure you want to clear the cart?')) {
            // Clear all items one by one (simplified approach)
            const items = document.querySelectorAll('.cart-item');
            items.forEach(item => {
                const itemId = item.dataset.id;
                removeItem(itemId);
            });
        }
    }
    
    function checkout() {
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        
        fetch('/api/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                payment_method: paymentMethod
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Sale completed successfully! Total: ksh ${data.total.toFixed(2)}`);
                loadCartItems();
            }
        });
    }
    
    // Search functionality
    document.getElementById('productSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const productCards = document.querySelectorAll('.product-card');
        
        productCards.forEach(card => {
            const productName = card.querySelector('h4').textContent.toLowerCase();
            if (productName.includes(searchTerm)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}